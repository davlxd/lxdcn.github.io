<!doctype html>




<html class="theme-next muse" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Networking policies in traditional companies are very strict due to its traditional nature. This may mean a lot from administrative or audit point of view, but as a developer, it makes me very difficu">
<meta property="og:type" content="article">
<meta property="og:title" content="Let SSH Tunnel Rescue You in Restricted Network Environment">
<meta property="og:url" content="https://post.lxd.me/2016-08-27-let-ssh-tunnel-rescue-you-in-restricted-network-environment/index.html">
<meta property="og:site_name" content="Thoughts, notes and collections">
<meta property="og:description" content="Networking policies in traditional companies are very strict due to its traditional nature. This may mean a lot from administrative or audit point of view, but as a developer, it makes me very difficu">
<meta property="og:updated_time" content="2017-01-25T06:53:05.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Let SSH Tunnel Rescue You in Restricted Network Environment">
<meta name="twitter:description" content="Networking policies in traditional companies are very strict due to its traditional nature. This may mean a lot from administrative or audit point of view, but as a developer, it makes me very difficu">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://post.lxd.me/2016-08-27-let-ssh-tunnel-rescue-you-in-restricted-network-environment/"/>





  <title> Let SSH Tunnel Rescue You in Restricted Network Environment | Thoughts, notes and collections </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-53165668-1', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Thoughts, notes and collections</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://post.lxd.me/2016-08-27-let-ssh-tunnel-rescue-you-in-restricted-network-environment/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lxd">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/alex-alice.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Thoughts, notes and collections">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Thoughts, notes and collections" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Let SSH Tunnel Rescue You in Restricted Network Environment
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-27T12:34:56+08:00">
              2016-08-27
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2017-01-25T14:53:05+08:00">
              2017-01-25
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">tech</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016-08-27-let-ssh-tunnel-rescue-you-in-restricted-network-environment/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016-08-27-let-ssh-tunnel-rescue-you-in-restricted-network-environment/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Networking policies in traditional companies are very strict due to its traditional nature. This may mean a lot from administrative or audit point of view, but as a developer, it makes me very difficult to apply DevOps practices like build CD pipeline, or at least deploy software to multiple environments automatically. And I seriously doubt how much it contributes to information security comparing how much trouble it makes.</p>
<p>One of many tough scenarios we’ve faced is this: we have 3 servers, <code>workstation</code> is a Windows server, which can ssh to Linux server <code>A</code> and <code>B</code>, but <code>A</code> and <code>B</code> are network isolated from each other, we need <code>A</code> to access the HTTP server on <code>B</code>.</p>
<p>The optimal way to solve these kinds of problems is trying to solve at higher levels, like convince policy makers to lower their strictness as it hurts productivity, sadly it’s always almost impossible, then we have to ask technology for help. Since the whole stack above OS is built on software so basically technology can do almost anything. But after all it’s local optimization, a twisted use case of technology.</p>
<p>Before I illustrate the solution by using SSH tunnel, let’s recap some basic concepts.</p>
<h2 id="Concepts-about-SSH-Tunnel"><a href="#Concepts-about-SSH-Tunnel" class="headerlink" title="Concepts about SSH Tunnel"></a>Concepts about SSH Tunnel</h2><p>SSH tunnel a.k.a. SSH port forwarding - as the name suggests - provides a way to forward connections to a local port, through SSH connection, to another server on behalf of SSH server, or the other way around, based on an established SSH connection. There are 3 kinds of SSH port forwarding: Local port forwarding, Remote port forwarding, and Dynamic port forwarding.</p>
<p>Let’s say Alice usually uses <code>laptop</code> to ssh to her  <code>ec2</code> on AWS like this: <code>[alice@laptop ~] $ ssh -p 22 alice@ec2</code> (with security group already configured to allow this connection).</p>
<p><strong>Local port forwarding</strong> makes TCP connections to a specific port on <code>laptop</code> get forwarded to another server by <code>ec2</code>, the magic option is <code>-L</code>. Alice can run <code>[alice@laptop ~] $ ssh -L 3000:server:4000 -p 22 alice@ec2</code> on her laptop, during the SSH session, accessing port 3000 on <code>laptop</code> is kind of the same as <code>ec2</code> accessing port 4000 on <code>server</code>. </p>
<p>For instance, there is a another Linux server <code>ec2_secret</code> to which <code>laptop</code> cannot ssh, but <code>ec2</code> can. After running <code>[alice@laptop ~] $ ssh -L 2200:ec2_secret:22 alice@ec2</code>, during the session, Alice can directly ssh to <code>ec2_secret</code> by running <code>[alice@laptop ~] $ ssh alice@localhost -p 2200</code>, instead of ssh to <code>ec2</code> then ssh to <code>ec2_secret</code> manually. This is <code>SSH Relay</code>.</p>
<p><strong>Remote port forwarding</strong> is kind of in the opposite direction, with magic option <code>-R</code>. After running <code>[alice@laptop ~] $ ssh -R 3000:server:4000 -p 22 alice@ec2</code>, during the ssh session, accessing port 3000 on <code>ec2</code> is the same as <code>laptop</code> accessing port 4000 on <code>server</code>.</p>
<p>For both <code>Local port forwarding</code> and <code>Remote port forwarding</code>, <code>server</code> can be same as a forwarding machine (<code>ec2</code> for <code>Local port forwarding</code>, <code>laptop</code> for <code>Remote port forwarding</code>), which is especially useful for <code>Remote port forwarding</code>. Consider this scenario: Alice usually leaves her laptop at home with a Wi-Fi network connection to a wireless router, when she goes to work, every now and then she wants to access her laptop by the PC in the company, what she gonna do? The pure command-line/SSH solution is very straightforward with the help of <code>Remote port forwarding</code>: Before she leaves home in the morning, she opens a <code>Remote port forwarding</code> ssh connection from her <code>laptop</code> to <code>ec2</code> like this <code>[alice@laptop ~] $ ssh -R 2200:localhost:22 -p 22 alice@ec2</code>, thus ssh connection to port 2200 on <code>ec2</code> itself will be forwarded to port 22 on <code>laptop</code> itself. When she arrives at company, she can ssh to <code>ec2</code> from her <code>PC</code> at first, then ssh to her <code>laptop</code> by <code>[alice@ec2 ~] $ ssh -p 2200 alice@localhost</code>.</p>
<p><strong>Dynamic port forwarding</strong> opens a SOCKS proxy port on top of an established SSH connection, we people in China use this to bypass GFW very often. Let’s assume Alice gets very lucky and takes a business trip to China, after she lands she finds herself won’t be able to access Google, Facebook, Twitter etc. If she can still access <code>ec2</code>, by running <code>[alice@laptop ~] $ ssh -D 1080 -C -p 22 alice@ec2</code> in terminal where <code>-D</code> stands for <strong>Dynamic port forwarding</strong> and <code>-C</code> stands for compress payload data, opens a SOCKS proxy on port 1080 on her laptop. The world will come back to live again after she sets SOCKS proxy to <code>127.0.0.1:1080</code> for the browser.</p>
<h2 id="Connecting-the-Dots"><a href="#Connecting-the-Dots" class="headerlink" title="Connecting the Dots"></a>Connecting the Dots</h2><p>After a full understanding of <code>Local port forwarding</code> and <code>Remote port forwarding</code>, the tough scenario at the beginning of this post can be easily handled by using <code>Local port forwarding</code> and <code>Remote port forwarding</code> together:<br>[alice@workstation ~] $ ssh -R 2000:localhost:3000 alice@A<br>[alice@workstation ~] $ ssh -L 3000:localhost:4000 alice@B</p>
<p>thus, server <code>A</code> can access HTTP service of port 4000 on server <code>B</code> by access <a href="http://localhost:2000" target="_blank" rel="external">http://localhost:2000</a>. </p>
<p>Furthermore, if HTTP port 2000 on server <code>A</code> needs to accept HTTP connection from other servers in the same network, just change <code>GatewayPorts</code> to <code>yes</code> in <code>/etc/ssh/sshd_config</code> on server <code>A</code>. </p>
<p>In a word, if one machine can ssh to another machine, these 2 machines then closely associated with each other: they can exchange files by <code>scp</code>, one can provision another by <code>Ansible</code>, and by <code>SSH Tunnel</code> one can access another’s resource on its behalf.</p>
<hr>
<h3 id="Refers"><a href="#Refers" class="headerlink" title="Refers"></a>Refers</h3><ul>
<li><a href="https://help.ubuntu.com/community/SSH/OpenSSH/PortForwarding" target="_blank" rel="external">https://help.ubuntu.com/community/SSH/OpenSSH/PortForwarding</a></li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016-08-15-ssh-tunnel-in-restricted-env/" rel="next" title="受限环境中的奇淫技巧之 — ssh通道">
                <i class="fa fa-chevron-left"></i> 受限环境中的奇淫技巧之 — ssh通道
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016-12-18-introvert-life/" rel="prev" title="“呵呵，其实我也是一个内向的人”">
                “呵呵，其实我也是一个内向的人” <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/alex-alice.png"
               alt="lxd" />
          <p class="site-author-name" itemprop="name">lxd</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">19</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Concepts-about-SSH-Tunnel"><span class="nav-number">1.</span> <span class="nav-text">Concepts about SSH Tunnel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Connecting-the-Dots"><span class="nav-number">2.</span> <span class="nav-text">Connecting the Dots</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Refers"><span class="nav-number">2.1.</span> <span class="nav-text">Refers</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lxd</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'post-lxd-me';
      var disqus_identifier = '2016-08-27-let-ssh-tunnel-rescue-you-in-restricted-network-environment/';

      var disqus_title = "Let SSH Tunnel Rescue You in Restricted Network Environment";


      function run_disqus_script(disqus_script) {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');

      
        var disqus_config = function () {
            this.page.url = disqus_url;
            this.page.identifier = disqus_identifier;
            this.page.title = disqus_title;
        };
        run_disqus_script('embed.js');
      

    </script>
  





  
  

  

  

  

  


</body>
</html>
