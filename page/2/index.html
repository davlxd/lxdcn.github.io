<!doctype html>




<html class="theme-next muse" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="Thoughts, notes and collections">
<meta property="og:url" content="https://post.lxd.me/page/2/index.html">
<meta property="og:site_name" content="Thoughts, notes and collections">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Thoughts, notes and collections">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://post.lxd.me/page/2/"/>





  <title> Thoughts, notes and collections </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-53165668-1', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Thoughts, notes and collections</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://post.lxd.me/2015-12-07-spring-data-jpa-internals/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lxd">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/alex-alice.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Thoughts, notes and collections">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Thoughts, notes and collections" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015-12-07-spring-data-jpa-internals/" itemprop="url">
                  Spring Data JPA 技术分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-12-07T12:34:56+08:00">
              2015-12-07
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2017-01-25T14:52:40+08:00">
              2017-01-25
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">tech</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015-12-07-spring-data-jpa-internals/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015-12-07-spring-data-jpa-internals/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在另一篇介绍Spring的文章<sup>[<a href="!--￼2--&gt;/collections/2015/12/01/spring-introduction/">1</a>]</sup>里我介绍了Spring Data JPA，借助Spring Data JPA，对数据库做CRUD需要简单的四步操作：先创建数据库表和Java entity类；声明一个接口<code>ItemRepository</code>继承<code>CrudRepository</code>；再在接口<code>ItemRepository</code>里声明Query Method<code>findByName</code>；最后把<code>ItemRepository</code>注入到我们需要用到的地方，调用就可以了。</p>
<p>这篇文章再深入一点，解释/分析一下Spring在背后做了什么；为什么作为一个Spring用户，我们声明一个接口，在接口里声明一个方法，我们就可以调用这个方法了操作数据库了？</p>
<p>先从Spring AOP说起。</p>
<h3 id="Spring-AOP-Proxy"><a href="#Spring-AOP-Proxy" class="headerlink" title="Spring AOP Proxy"></a>Spring AOP Proxy</h3><p>AOP（面向切面编程，Aspect-Oriented Programming），是Java里常用的一个编程范式。OOP对逻辑和数据做了一定程度的封装，但是当应用运行起来之后，从数据流的角度来看，数据是从一个类实例流到另一个实例，是链式的，我们编写的业务逻辑也是在一条条调用链上做文章。而AOP则是从另一个维度做文章：比如说原来的模块划分，或者调用链是纵向的，那么AOP是从横向切入，把纵向维度中共性的部分，比如logging、auth、cache，抽取出来，并且用IoC<sup>[<a href="https://en.wikipedia.org/wiki/Inversion_of_control" target="_blank" rel="external">2</a>]</sup>的思想，由抽取出来的<code>aspect</code>承担匹配和执行的责任，原来的业务逻辑不需要添加/改动任何代码。</p>
<p>举例来说，AOP可以做这样的事情：“让一个Web应用中所有Controller的POST方法执行之前打一条log”。抽取出来做这件事情的模块称为<code>aspect</code>，描述匹配到“所有Controller的POST方法”的谓词称为<code>pointcut</code>，“打log”这样的行为称为<code>advice</code>。</p>
<p>AspectJ是这个Java里AOP鼻祖老爷，Spring AOP兼容了一部分AspectJ的annotation，但核心还是Spring自己的，这个核心就是AOP proxy。比如我们有一个接口<code>Pojo</code>和它的实现<code>SimplePojo</code>，当没有proxy的时候，调用<code>SimplePojo</code>的<code>foo</code>方法是这样的：</p>
<p><img src="/images/aop-proxy-plain-pojo-call.png" alt="Plain POJO call without Proxy"></p>
<p>当我们创建一个<code>SimplePojo</code>的proxy之后，调用这个proxy的<code>foo</code>方法的是这样的：</p>
<p><img src="/images/aop-proxy-call.png" alt="AOPproxy"><br>（两张图片都来自Spring官方文档）</p>
<p>即proxy“代理”了对原对象原方法的调用，在这个代理的过程中我们可以执行<code>advice</code>，比如Spring AOP中的方法拦截器。下面的代码演示了如何用Spring AOP的底层API创建一个proxy。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">I</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">implements</span> <span class="title">I</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">m</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"m in C"</span>; &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">I2</span> <span class="keyword">extends</span> <span class="title">I</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">m</span><span class="params">()</span></span>;</div><div class="line">    <span class="function">String <span class="title">m2</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">proxyDemo</span><span class="params">()</span> </span>&#123;</div><div class="line">        ProxyFactory result = <span class="keyword">new</span> ProxyFactory();</div><div class="line"></div><div class="line">        result.setTarget(<span class="keyword">new</span> C());</div><div class="line">        result.setInterfaces(I2.class);</div><div class="line">        result.addAdvice(<span class="keyword">new</span> MethodInterceptor() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">                <span class="keyword">if</span> (invocation.getMethod().getName().equals(<span class="string">"m2"</span>)) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="string">"m2 in proxy"</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> invocation.getThis().getClass().getMethod(invocation.getMethod().getName()).invoke(invocation.getThis());</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        I2 proxy = (I2) result.getProxy();</div><div class="line"></div><div class="line">        System.out.println(proxy.m());   <span class="comment">//Output: `m in C'</span></div><div class="line">        System.out.println(proxy.m2());  <span class="comment">//Output: `m2 in proxy'</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>首先声明一个接口<code>I</code>；类<code>C</code>实现接口<code>I</code>的同时自己定义了一个方法<code>m()</code>；接口<code>I2</code>继承<code>I</code>并声明了方法<code>m()</code>和方法<code>m2()</code>。ProxyFactory是Spring AOP的proxy工厂类，实例化之后，设置proxy的target为<code>C</code>的实例，要代理的接口为<code>I2</code>，然后添加一个方法拦截器。</p>
<p>方法拦截器是一个接口，我们实例化的匿名内部类的<code>invoke()</code>方法就是这个拦截器的回调。当调用的方法名字是<code>m2</code>的时候，拦截器直接返回一个字符串<code>m2 in proxy</code>。当调用的方法名字是<code>m</code>的时候，通过反射获取到target（<code>C</code>的实例）的<code>m()</code>方法，调用执行。<br><br><br>介绍了Spring AOP Proxy之后，就可以解释一开始那个问题的前半部分了——为什么在我们只声明了一个接口和方法的情况下，这个方法可以被调用到？事实上上面的demo已经基本上了回答了这个问题，接下来我把各部分逻辑对应到Spring Data JPA上。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ItemRepository</span> <span class="keyword">extends</span> <span class="title">CrudRepository</span>&lt;<span class="title">Item</span>, <span class="title">String</span>&gt; </span>&#123;</div><div class="line">    <span class="function">List&lt;Item&gt; <span class="title">findByName</span><span class="params">(String name)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Spring在创建的名为<code>itemRepository</code>的bean，就是一个proxy，这个proxy在<code>RepositoryFactorySupport</code>里完成了初始化和配置<sup>[<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L177" target="_blank" rel="external">3</a>]</sup>；Proxy的target是<code>SimpleJpaRepository</code><sup>[<a href="https://github.com/spring-projects/spring-data-jpa/blob/fda74889de51e586bfa22033aed0affb6f7f4c76/src/main/java/org/springframework/data/jpa/repository/support/SimpleJpaRepository.java" target="_blank" rel="external">4</a>]</sup>，它用<code>EntityManager</code>实现了<code>CrudRepository</code>里的基本CRUD方法；Proxy的代理接口即<code>ItemRepository</code>和<code>Repository</code><sup>[<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L190" target="_blank" rel="external">5</a>]</sup>；Proxy添加了多个方法拦截器，处理自定义Query Method的拦截器是<sup>[<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L375" target="_blank" rel="external">6</a>]</sup>，这个拦截器在构造函数里遍历<code>ItemRepository</code>里的Query Method，创建一个<code>RepositoryQuery</code>对象放到一个map中<sup>[<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L461" target="_blank" rel="external">7</a>]</sup>。</p>
<p>当我们的代码调用到<code>itemRepository.findByName()</code>的时候，即进入到方法拦截器的<code>invoke</code>方法<sup>[<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L438" target="_blank" rel="external">8</a>]</sup>，拦截器首先判断是不是Query Method<sup>[<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L461" target="_blank" rel="external">9</a>]</sup>，如果是的话就取出<code>RepositoryQuery</code>对象带参数执行，不是的话调用<code>SimpleJpaRepository</code>里的方法<sup>[<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L467" target="_blank" rel="external">10</a>]</sup>。</p>
<h3 id="Mini-Parser"><a href="#Mini-Parser" class="headerlink" title="Mini Parser"></a>Mini Parser</h3><p>下面接着继续分析开题问题的第二部分，为什么我们只声明一个<code>findByName</code>的方法，Spring就知道如何去查询数据库了？</p>
<p>事实上细细想来这个并不特别神奇，我们在声明query methods的时候，是需要遵循规范的<sup>[<a href="http://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-creation" target="_blank" rel="external">11</a>]</sup>，既然我们定义方法遵循了规范，Spring基于同样的规范，用一个parser解析这个方法名，就能生成JPA的查询对象。</p>
<p>我们在前面提到Spring会根据<code>ItemRepository</code>里的Query Method，创建一个<code>RepositoryQuery</code>对象<sup>[<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L461" target="_blank" rel="external">7</a>]</sup>，这个对象就是一个迷你的parser解析query method方法名的结果，解析的入口在<sup>[<a href="https://github.com/spring-projects/spring-data-jpa/blob/master/src/main/java/org/springframework/data/jpa/repository/query/JpaQueryLookupStrategy.java#L95" target="_blank" rel="external">12</a>]</sup>。</p>
<p>这个mini parser是自顶向下解析的，最顶上的节点类是<code>PartTree</code><sup>[<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/query/parser/PartTree.java#L76" target="_blank" rel="external">13</a>]</sup>，它包含两个字段/子节点，<code>subject</code>和<code>predicate</code>。<code>subject</code>表示要查询的结果，<code>predicate</code>表示查询的条件。比如对于<code>findByName</code>，<code>subject</code>为空，<code>predicate</code>为<code>Name</code>；再比如稍微复杂一点的<code>findDistinctUserByNameOrderByAge</code>，subject是<code>DistinctUser</code>，predicate是<code>NameOrderByAge</code>。</p>
<p><code>Subject</code>有3个boolean属性，分别是<code>distinct</code>，<code>count</code>，<code>delete</code>，<code>maxResults</code><sup>[<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/query/parser/PartTree.java#L275" target="_blank" rel="external">14</a>]</sup>，如果query带了<code>Distinct``distinct</code>就是true，count方法<code>count</code>为true，delete方法<code>delete</code>为true。<code>maxResults</code>是limit查询的值，如<code>findFirst10ByLastname</code>。</p>
<p><code>Predicate</code>有一个ArrayList<code>nodes</code>包含以<code>Or</code>split后的节点<code>OrPart</code>，还有一个<code>orderBySource</code>包含用<code>OrderBy</code>split的排序节点<sup>[<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/query/parser/PartTree.java#L345" target="_blank" rel="external">15</a>]</sup>。</p>
<p>……</p>
<p><code>OrPart</code>节点往后不再赘述推导规则了，最后，定义一个比较复杂的方法看一下AST。对于<code>findDistinctByStateAndCountryLikeOrMapAllIgnoringCaseOrderByNameDesc</code>，AST如下图</p>
<p><img src="/images/ast-of-a-long-query-method.png" alt="AST of a long Query Method"></p>
<p>有了AST之后，Spring Data再调用JPA的接口创建<code>Predicate</code>对象、<code>CriteriaQuery</code>对象等，交给JPA查询DB<sup>[<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/query/parser/AbstractQueryCreator.java#L98" target="_blank" rel="external">16</a>]</sup>。</p>
<p>这个规则和parser都很简陋，很容易出现二义的情况，如果遇到这样的情况，就不一定非要苦苦纠结于解析规则了，它目的毕竟还是为了给用户提供方便，如果不能很方便的提供方便，那就给字段改个名儿，或者改用Named Query<sup>[<a href="http://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.named-queries" target="_blank" rel="external">17</a>]</sup>。</p>
<p><br><br></p>
<p>参考资料：</p>
<ul>
<li><a href="http://docs.spring.io/spring-data/jpa/docs/current/reference/html/" target="_blank" rel="external">http://docs.spring.io/spring-data/jpa/docs/current/reference/html/</a></li>
<li><a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/aop-api.html" target="_blank" rel="external">http://docs.spring.io/spring/docs/current/spring-framework-reference/html/aop-api.html</a></li>
<li>[1]<a href="http://post.lxd.me/2015-12-01-spring-introduction/">http://post.lxd.me/2015-12-01-spring-introduction/</a></li>
<li>[2]（控制反转的思想，不特指Spring DI） <a href="https://en.wikipedia.org/wiki/Inversion_of_control" target="_blank" rel="external">https://en.wikipedia.org/wiki/Inversion_of_control</a></li>
<li>[3]<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L177" target="_blank" rel="external">https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L177</a></li>
<li>[4]<a href="https://github.com/spring-projects/spring-data-jpa/blob/fda74889de51e586bfa22033aed0affb6f7f4c76/src/main/java/org/springframework/data/jpa/repository/support/SimpleJpaRepository.java" target="_blank" rel="external">https://github.com/spring-projects/spring-data-jpa/blob/fda74889de51e586bfa22033aed0affb6f7f4c76/src/main/java/org/springframework/data/jpa/repository/support/SimpleJpaRepository.java</a></li>
<li>[5]<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L190" target="_blank" rel="external">https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L190</a></li>
<li>[6]<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L375" target="_blank" rel="external">https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L375</a></li>
<li>[7]<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L461" target="_blank" rel="external">https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L461</a></li>
<li>[8]<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L438" target="_blank" rel="external">https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L438</a></li>
<li>[9]<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L461" target="_blank" rel="external">https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L461</a></li>
<li>[10]<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L467" target="_blank" rel="external">https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/core/support/RepositoryFactorySupport.java#L467</a></li>
<li>[11]<a href="http://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-creation" target="_blank" rel="external">http://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-creation</a></li>
<li>[12]<a href="https://github.com/spring-projects/spring-data-jpa/blob/master/src/main/java/org/springframework/data/jpa/repository/query/JpaQueryLookupStrategy.java#L95" target="_blank" rel="external">https://github.com/spring-projects/spring-data-jpa/blob/master/src/main/java/org/springframework/data/jpa/repository/query/JpaQueryLookupStrategy.java#L95</a></li>
<li>[13]<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/query/parser/PartTree.java#L76" target="_blank" rel="external">https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/query/parser/PartTree.java#L76</a></li>
<li>[14]<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/query/parser/PartTree.java#L275" target="_blank" rel="external">https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/query/parser/PartTree.java#L275</a></li>
<li>[15]<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/query/parser/PartTree.java#L345" target="_blank" rel="external">https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/query/parser/PartTree.java#L345</a></li>
<li>[17]<a href="http://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.named-queries" target="_blank" rel="external">http://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.named-queries</a></li>
<li>[16]<a href="https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/query/parser/AbstractQueryCreator.java#L98" target="_blank" rel="external">https://github.com/spring-projects/spring-data-commons/blob/01f2c30b1d1c342e168b3b541974332cc429e3e2/src/main/java/org/springframework/data/repository/query/parser/AbstractQueryCreator.java#L98</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://post.lxd.me/2015-12-01-spring-introduction/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lxd">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/alex-alice.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Thoughts, notes and collections">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Thoughts, notes and collections" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015-12-01-spring-introduction/" itemprop="url">
                  Spring 介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-12-01T12:34:56+08:00">
              2015-12-01
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2017-01-25T14:52:38+08:00">
              2017-01-25
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">tech</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015-12-01-spring-introduction/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015-12-01-spring-introduction/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这篇文章对Spring Framework做一个基础的介绍，先介绍Spring和Spring相关的几个概念，再介绍3个常用的Spring项目/模块：Spring MVC、Spring Data JPA、和Spring Boot。</p>
<h3 id="Spring-和-Java-EE"><a href="#Spring-和-Java-EE" class="headerlink" title="Spring 和 Java EE"></a>Spring 和 Java EE</h3><p><img src="/images/spring-java-ee.png" alt="Spring and Java EE"></p>
<p>Java平台有多个“版本”，和Spring相关的有两个：Java SE和Java EE。Java SE（Java Platform, Standard Edition）包含JVM和Java最核心/基本的类库API；而Java EE（Java Platform, Enterprise Edition）是在Java SE之上，定义的一套specifications，用来支持所谓的Enterprise/企业级开发，比如用来接受处理HTTP请求的servlet specification、和关系型数据库交互的API（JPA）等。Java EE定义的每一条规范称为JSR（Java Specification Request），由JCP（Java Community Process）开发维护，就像RFC之于IETF。</p>
<p>有标准就有实现，基于Java EE的标准，业界有好些个实现，这些实现基本都是“大公司”的产品，比如IBM的WebSphere Application Server（WAS），Oracle的WebLogic，RedHat的JBoss/WildFly等等，这些实现都遵循Java EE的标准，而且实现了Servlet spec、JPA spec等大部分重要的specification，称为应用服务器（Application Server），Java EE规范保证了我们编写的应用能够部署/运行在上面；而在开源界更常用的Tomcat/Jetty则称为Web容器（Web Container），只实现了Java EE里的Servlet spec、JSP spec等和Web相关的specification，我们如果需要依赖注入，就需要自己引入Spring，需要用JPA访问关系型数据库，就需要自己引入Hibernate。</p>
<p>而且Spring在严格意义上来说并不是Java EE的实现，因为它一方面遵循了Java EE的Servlet、JPA等核心接口，但是对于更上层的API，Spring用的是自己的东西，比如依赖注入（Spring DI vs CDI），RESTful Web Service（Spring MVC vs JAX-RS）。</p>
<h3 id="Spring-IoC-DI"><a href="#Spring-IoC-DI" class="headerlink" title="Spring IoC / DI"></a>Spring IoC / DI</h3><p>Spring框架最核心的概念就是它基于控制反转技术（Inversion of Control - IoC）的依赖注入（Dependency Injection - DI），这两个狰狞的名词到底是什么意思？我简单描述一下。</p>
<p>抛开Spring，IoC是一种思想，一种技术，即对于一个主体而言，原来由他主动负责/发起的工作，变成了由它被动接受，这个由主动变被动的过程，称为IoC。比如library和framework就是一个很典型的好例子：当我们使用library，我们编写的代码调用lib，我们是主动方、发起方；而当我们改用framework，我们编写的代码则作为framework的回调、实现、或被托管对象，我们从主动方变成了被动方。通过IoC，我们可以解耦，可以解除主体的责任，可以解放自己。</p>
<p>Spring IoC（a.k.a. Spring DI）就是IoC在Spring里的一个应用，它把本来应该由我们自己写代码主动负责的对象实例化和依赖引用的过程，交由Spring来完成，举个例子：</p>
<p>在不借助DI，我们用Java写一个application的时候，如果Class A依赖于Class B和Class C，我们可以把B的实例由构造函数/setter函数传进去，C的实例由A自己实例化一个出来，就像这样：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> B b;</div><div class="line">    <span class="keyword">private</span> C c = <span class="keyword">new</span> C();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">(B b)</span> </span>&#123; <span class="keyword">this</span>.b = b; &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setB</span><span class="params">(B b)</span> </span>&#123; <span class="keyword">this</span>.b = b; &#125;</div><div class="line">&#125;</div><div class="line">A a = <span class="keyword">new</span> A(<span class="keyword">new</span> B());</div></pre></td></tr></table></figure></p>
<p>借助Spring DI和其他一些技术，可以这样：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> B b;</div><div class="line">    <span class="meta">@Autowired</span> <span class="keyword">private</span> C c;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">(B b)</span> </span>&#123; <span class="keyword">this</span>.b = b; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里步子跨的有点大，<code>@Component</code>标签告诉Spring这个类需要被实例化为一个bean，bean是由Spring管理的一个Java对象实例，所以在这里Class A B C都会被Spring实例化为bean。<code>@Autowired</code>标签告诉Spring去寻找一个类型匹配的bean注入到该字段/方法，形成对B和C的引用，这便是<u>依赖注入</u>。</p>
<p>所以，本来应该由的代码负责的，把B和C的实例交给A的实例引用的过程，变成了在代码中只声明依赖，由Spring完成实例化和实例之间的引用，这就是IoC — Inversion of Control——<u>控制反转</u>。</p>
<h3 id="Web-Container"><a href="#Web-Container" class="headerlink" title="Web Container"></a>Web Container</h3><p>Web Container，Web容器，也叫Servlet容器。我们用Spring构建的Web应用是要借助一个容器来运行的，比如Tomcat、Jetty，GlassFish。因为无论是用Spring还是其他Java EE框架编写出来的Web应用，都是是一个个独立的servlet，或者基于servlet的东西，这些独立的servlet不能直接运行，也不能直接接收来自浏览器的HTTP请求。Tomcat/Jetty这些容器一方面是一个Web服务器——即和浏览器交互，接收/响应HTTP请求；另一方面是Servlet容器——加载servlet，负责管理他们的生命周期，根据mapping规则把分发给响应的servlet，如下图</p>
<p><img src="/images/servlet-container.png" alt="Servlet"></p>
<p>这一整套都是Java EE Servlet规范，Spring和容器都得遵守这些规范，用Spring写的Web应用才可以部署到Web容器里去。</p>
<h3 id="Spring-MVC"><a href="#Spring-MVC" class="headerlink" title="Spring MVC"></a>Spring MVC</h3><p>Spring框架由诸多模块组成，最核心的有spring-core、spring-beans，和数据库交互的有spring-jdbc、spring-orm等，我们用Spring来构建Web项目比较多，所以介绍一下Spring Web MVC模块。</p>
<p>Servlet是Java EE里处理HTTP请求的技术/规范，Spring MVC也是基于servlet来设计的，基于一个核心的<code>DispatcherServlet</code>，HTTP请求进来之后由它分发给其他的Controller处理。下面是在Spring里写一个Controller的demo，另外Spring MVC提供了Model-View-Controller的完整功能，但在这前后端分离的年代，就只demo提供RESTful API、返回JSON的Controller写法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/stores/&#123;storeId&#125;/items"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemController</span> </span>&#123;</div><div class="line">    <span class="meta">@RequestMapping</span>(path = <span class="string">"/&#123;itemId&#125;"</span>, method = RequestMethod.GET, produces = MediaType.APPLICATION_JSON_UTF8_VALUE)</div><div class="line">    <span class="function"><span class="keyword">public</span> Item <span class="title">retrieveItem</span><span class="params">(@PathVariable String storeId, @PathVariable String itemId)</span> </span>&#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> item;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(method = RequestMethod.POST)</div><div class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity <span class="title">createItem</span><span class="params">(@RequestBody Item item)</span> </span>&#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(HttpStatus.OK);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>@RestController</code>标记在一个Java类上，告诉Spring MVC这是一个RESTful API Controller，所有的Controller同时也都是Spring管理的bean；</li>
<li><code>@RequestMapping</code>描述了URL的路由映射。标记在类上的<code>@RequestMapping</code>定义了顶层的路径，结合在方法上的<code>@RequestMapping</code>的路径和HTTP method，将一个HTTP请求映射到一个Java方法上，由这个方法来处理HTTP请求，返回HTTP响应。</li>
<li><code>@RequestMapping</code>中定义路径的字符串支持URI Template<sup>[<a href="https://tools.ietf.org/html/rfc6570" target="_blank" rel="external">1</a>]</sup>，路径中{变量}所代表的的值，用<code>@PathVariable</code>标记在同名的Java方法参数上提取出来。</li>
<li><code>@RequestBody</code>标记在Java方法参数上，Spring MVC会自动把HTTP请求转成Java对象，绑定在这个参数上；同样的，因为我们标记了这个类为RESTful Controller，Java方法的返回值会直接转成JSON；</li>
<li><code>ResponseEntity</code>是一个泛型类，包装了Controller返回的HTTP response内容，增加了可以控制HTTP响应头、状态码的方法，代码里返回一个空的HTTP响应，状态码设置为200。</li>
</ul>
<p>写一个最简单的Item类，用cURL调用RESTful接口可以看到下面的执行结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Item</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> name; &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123; <span class="keyword">this</span>.name = name; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$ curl -v http://localhost:8080/stores/16/items/1</div><div class="line">...</div><div class="line">&gt; </div><div class="line">&lt; HTTP/1.1 200 OK</div><div class="line">&lt; Server: Apache-Coyote/1.1</div><div class="line">&lt; Content-Type: application/json;charset=UTF-8</div><div class="line">...</div><div class="line"></div><div class="line">&#123;&quot;name&quot;:&quot;hehe&quot;&#125;%</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">curl -v -H &quot;Content-Type: application/json&quot; -i -X POST -d &apos;&#123;&quot;name&quot;:&quot;haha&quot;&#125;&apos; http://localhost:8080/stores/16/items</div><div class="line">...</div><div class="line">&gt; Content-Type: application/json</div><div class="line">&gt; Content-Length: 15</div><div class="line">&gt; </div><div class="line">&lt; HTTP/1.1 200 OK</div><div class="line">&lt; Server: Apache-Coyote/1.1</div><div class="line">&lt; Content-Length: 0</div><div class="line">...</div><div class="line"></div></pre></td></tr></table></figure>
<h3 id="Spring-Data-JPA"><a href="#Spring-Data-JPA" class="headerlink" title="Spring Data JPA"></a>Spring Data JPA</h3><p>过去我们谈起Spring是一个framework，但是现在的Spring更多的像一个family/collection，基于核心的Spring Framework之上做了好些project<sup>[<a href="https://spring.io/projects" target="_blank" rel="external">2</a>]</sup>，Spring Data就是其中之一。Spring Data给数据库的访问提供了一个更优雅/强大的接口，Spring Data JPA是基于JPA、针对关系型数据库的子模块，给我们写应用日常遇到的简单CRUD提供了一个非常干净的接口。</p>
<p>Spring Data / JPA 提供给我们用户的是一系列Java interface，它在背后用基于Dynamic Proxy的AOP帮我们完成了实际的工作。最顶层的<code>Repository&lt;T, ID extends Serializable&gt;</code>，提供了最基本CRUD操作的<code>CrudRepository&lt;T, ID extends Serializable&gt;</code>，JPA相关操作的<code>JpaRepository&lt;T, ID extends Serializable&gt;</code>等。它们都是泛型接口，第一个类型参数是对应到数据库的实体类，第二个参数是实体类里ID的类型。我们声明一个接口继承这些接口，再申明一些我们自己的方法进去，就可以完成大部分简单的数据库操作了。</p>
<p>借助Spring Data JPA，对数据库做简单的CRUD需要四步操作：</p>
<p>第一步，在数据库中创建表，然后创建一个entity类映射它<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> item (</div><div class="line">  <span class="keyword">id</span>          <span class="built_in">VARCHAR</span>(<span class="number">36</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="keyword">name</span>        <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  description <span class="built_in">VARCHAR</span>(<span class="number">128</span>),</div><div class="line">  <span class="keyword">CONSTRAINT</span> itemPk PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>)</div><div class="line">);</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Entity</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Item</span> </span>&#123;</div><div class="line">    <span class="meta">@Id</span></div><div class="line">    <span class="meta">@GeneratedValue</span>(generator = <span class="string">"uuid"</span>)</div><div class="line">    <span class="meta">@GenericGenerator</span>(name = <span class="string">"uuid"</span>, strategy = <span class="string">"uuid2"</span>)</div><div class="line">    <span class="keyword">private</span> String id;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Item</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Item</span><span class="params">(String name, String description)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.description = description;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> String description;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>第二步，声明一个接口，继承填入类型参数的<code>CrudRepository</code>接口<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ItemRepository</span> <span class="keyword">extends</span> <span class="title">CrudRepository</span>&lt;<span class="title">Item</span>, <span class="title">String</span>&gt; </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>第三步，<code>CrudRepository</code>接口里已经声明了一些最基本的CRUD方法<code>save(S entity)</code>，<code>findOne(ID id)</code>，<code>exists(ID id)</code>，<code>delete(ID id)</code>等，我们可以在声明的接口里再进一步声明一些我们业务上需要的方法，但是要根据一定的命名规则<sup>[<a href="http://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-creation" target="_blank" rel="external">3</a>]</sup>。比如根据<code>name</code>查找出所有同名的item的方法声明为<code>findByName</code>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ItemRepository</span> <span class="keyword">extends</span> <span class="title">CrudRepository</span>&lt;<span class="title">Item</span>, <span class="title">String</span>&gt; </span>&#123;</div><div class="line">    <span class="function">List&lt;Item&gt; <span class="title">findByName</span><span class="params">(String name)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>第四步，把<code>ItemRepository</code>注入到我们需要用到的地方，调用就可以了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SomeClient</span> </span>&#123;</div><div class="line">  <span class="meta">@Autowired</span> <span class="keyword">private</span> ItemRepository itemRepository;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</div><div class="line">    List&lt;Item&gt; items = itemRepository.findByName(<span class="string">"teapot"</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomethingElse</span><span class="params">()</span> </span>&#123;</div><div class="line">    Item newItem = <span class="keyword">new</span> Item(<span class="string">"smug"</span>, <span class="string">"smug without mug"</span>);</div><div class="line">    itemRepository.save(newItem);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>自定义查询方法除了简单的findBy…以外还可以进行更丰富的组合：and、or、pagination、limit、asc/desc等<sup>[<a href="http://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-creation" target="_blank" rel="external">3</a>]</sup>。</p>
<p>那么Spring Data是怎么做这些magic的？其实这对Spring核心来说来说都不是很困难。首先用基于Dynamic Proxy的Spring AOP，创建一个proxy作为<code>itemRepository</code>的bean实例，然后解析所有的自定义方法如<code>findByName</code>，用一个迷你的parser解析方法名，将AST保存在bean上；当应用启动我们的代码调用到<code>findByName</code>的时候，Spring AOP拦截了方法调用，取出AST，解析成一个Query对象，再结合参数交给JPA实现做查询，我在另外一篇文章<sup>[<a href="http://post.lxd.me/2015-12-07-spring-data-jpa-internals">4</a>]</sup>做了更详细的分析。</p>
<h3 id="Spring-Boot"><a href="#Spring-Boot" class="headerlink" title="Spring Boot"></a>Spring Boot</h3><p>Spring Boot是另一个Spring project，Convention over Configuration风的追随者。它基于Spring做了很多工作，使得编写一个Spring应用变的非常容易。</p>
<p>以往我们初始化一个Java应用需要在maven/gradle配置文件里历数写上它的依赖，非常繁复，Spring Boot非常体贴的给我们提供了<code>Start POMs</code>——一站式的jar包依赖解决方案。它从Spring用户的视角，对有关联的、通常会一起使用的第三方依赖做了编组，当我们需要Spring的哪部分功能的时候，在配置文件里写入对应编组的artifactId作为依赖就好了。比如我们需要做Web应用，一般需要Spring MVC的依赖，spring-web模块，Jackson的依赖等，在Spring Boot里我们引入<code>spring-boot-starter-web</code>就可以了。类似的还有包含JUnit、Hamcrest和Mockito等测试工具的<code>spring-boot-starter-test</code>，Spring Data JPA相关的<code>spring-boot-starter-data-jpa</code>等。</p>
<p>传统的Spring Web应用打包之后需要放在Tomcat/Jetty容器下面运行，Spring Boot应用引入<code>spring-boot-starter-web</code>依赖之后还会引入一个内嵌的Tomcat，这个内嵌的Tomcat可以通过调用<code>SpringApplication.run()</code>再借助Spring Boot的自动配置启动。这样我们编写一个入口main函数，就可以直接启动Web应用了，无论是命令行、IDE、亦或打成一个独立的jar包用<code>java -jar</code>运行。</p>
<p>Spring Boot在减少配置方面还做了很多细的调优。比如对于ORM，一个Java entity类对应到数据库的一张表的时候，默认Java entity类的字段名对应到数据库的字段名。如果JPA用的是Hibernate，并且配置了<code>ImprovedNamingStrategy</code>，就可以把entity类里的camelCase的字段名映射到数据库表里snake_case的字段名，很有Convention Over Configuration的范儿了，但是对于外键却是不生效的。Spring Boot提供了一个<code>SpringNamingStrategy</code>继承<code>ImprovedNamingStrategy</code>，添加了对外键的支持。</p>
<h3 id="一些细节"><a href="#一些细节" class="headerlink" title="一些细节"></a>一些细节</h3><blockquote>
<p>不要在意那些细节！</p>
<p>&nbsp; <span style="float:right; margin-right:10%">—— Coney Wu</span></p>
</blockquote>
<p>Spring 自动装配（autowire）就是自动发现匹配的bean注入到有依赖的bean里面去。所谓自动发现，就是Spring扫描ApplicationContext。所谓匹配，有两种，一种是byName——有依赖的bean的属性名字和被依赖的bean名字相同；另一种是byType——有依赖的bean的属性类型和被依赖的bean类型相同，当有多个同一类型的bean的时候，就会抛exception。@Autowired annotation是byType匹配的，如果有多个同类型的bean，可以结合@Qualifier annotation<sup>[<a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html#beans-autowired-annotation-qualifiers" target="_blank" rel="external">5</a>]</sup>指定到特定的bean上。</p>
<p>如果bean之间互相依赖，或者出现环会不会报错？——如果整条环上的bean之间都是<u>构造函数依赖注入</u>的方式互相依赖的话就会报错，前面实例代码里的注入方式即<u>构造函数依赖注入</u>，这种依赖注入方式表明要想实例化class A，必须先注入class B的实例化bean，如果class B也构造函数注入依赖于class A，那么就陷入死循环了。解决方法是把Spring启动先初始化的那个bean的<u>构造函数依赖注入</u>换成基于setter函数的依赖注入，或者用<code>@Autowired</code>注入到类的字段。但是通常情况下我们又不想去关心/控制bean的初始化顺序，这时候全部用setter函数注入或者用<code>@Autowired</code>注入类字段就是比较省心的方案。</p>
<p>Web容器和Web应用交互的入口点是一个称为deployment descriptor file的文件，即web.xml，再WEB-INF/文件夹下面，它定义了诸如servlet、servlet和URL的mapping、event listeners等</p>
<p>Java对象到JSON的相互转换只是属于Java和HTTP req/res相互转换中的一种，转换方法都继承于<code>HttpMessageConverter&lt;T&gt;</code>接口。在Spring里注册有有多个实现类，JSON的转换是由<code>MappingJackson2HttpMessageConverter</code>完成的，依赖于Jackson。</p>
<p>Spring Boot的另一个消灭手动配置的重要手法是自动配置，即根据应用现在CLASSPATH里的依赖的jar自动配置Spring，用<code>@EnableAutoConfiguration</code>注解开启，对Spring Boot来说几乎也是必须的。</p>
<p>Spring Boot应用有一个入口类标记了<code>@Configuration</code>。还有一个静态的main方法作为程序的入口，main方法再调用<code>SpringApplication</code>，把当前类作为入口配置传参数进去，<code>SpringApplication</code>再去启动内嵌tomcat等后续过程。</p>
<h3 id="Further-Reading"><a href="#Further-Reading" class="headerlink" title="Further Reading"></a>Further Reading</h3><p>这篇文章对Spring做了一个很基本的介绍，略去了很多的细节，Spring的官方文档提供了更全面和详细的阐述<sup>[<a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/" target="_blank" rel="external">0</a>]</sup>。Spring的模块/项目/子框架很多，除了我介绍的这三个，还有如切面编程的Spring AOP，Authentication和Authorization的框架Spring Security等等都是易学好用的车轮子。Spring Boot除了我上述的几个特性以外也还有很多值得关注的内容，如Spring Initializer、用于生产环境监控的actuator等等，一切的一切，都在Spring的官方文档里。</p>
<p><br></p>
<p>参考资料：</p>
<ul>
<li><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/reflection/proxy.html" target="_blank" rel="external">https://docs.oracle.com/javase/8/docs/technotes/guides/reflection/proxy.html</a></li>
<li><a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/aop-api.html" target="_blank" rel="external">http://docs.spring.io/spring/docs/current/spring-framework-reference/html/aop-api.html</a></li>
<li><a href="http://docs.spring.io/spring-data/jpa/docs/current/reference/html" target="_blank" rel="external">http://docs.spring.io/spring-data/jpa/docs/current/reference/html</a></li>
<li><a href="http://sivalabs.in/2015/06/a-developers-perspective-on-spring-vs-javaee.html" target="_blank" rel="external">http://sivalabs.in/2015/06/a-developers-perspective-on-spring-vs-javaee.html</a></li>
<li>[0]<a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/" target="_blank" rel="external">http://docs.spring.io/spring/docs/current/spring-framework-reference/html/</a></li>
<li>[1]<a href="https://tools.ietf.org/html/rfc6570" target="_blank" rel="external">https://tools.ietf.org/html/rfc6570</a></li>
<li>[2]<a href="https://spring.io/projects" target="_blank" rel="external">https://spring.io/projects</a></li>
<li>[3]<a href="http://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-creation" target="_blank" rel="external">http://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-creation</a></li>
<li>[4]<a href="http://post.lxd.me/2015-12-07-spring-data-jpa-internals/">http://post.lxd.me/2015-12-07-spring-data-jpa-internals/</a></li>
<li>[5]<a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html#beans-autowired-annotation-qualifiers" target="_blank" rel="external">http://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html#beans-autowired-annotation-qualifiers</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://post.lxd.me/2015-02-17-Jing-Wong-autobiography-review/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lxd">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/alex-alice.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Thoughts, notes and collections">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Thoughts, notes and collections" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015-02-17-Jing-Wong-autobiography-review/" itemprop="url">
                  王晶的香港电影史
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-02-17T00:00:00+08:00">
              2015-02-17
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-11-09T18:25:15+08:00">
              2016-11-09
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/book-review/" itemprop="url" rel="index">
                    <span itemprop="name">book review</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015-02-17-Jing-Wong-autobiography-review/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015-02-17-Jing-Wong-autobiography-review/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://img1.doubanio.com/img/celebrity/large/3237.jpg" alt="王晶"></p>
<p><br><br>王晶导演的电影不怎么喜欢，但是形象很可爱，胖胖的、笑眯眯的，憨态可掬。最近翻到到他写的自传：《少年王晶创江湖》（原发于明报周刊，这是单行本）。写的很好，很精彩，说了不少大实话，我拣几段抄在这里。</p>
<p>王晶先入行电视业做编剧，积累了深厚的喜剧功底，年少成名，很早就制作出了一批收视率极高的剧集，“一九七九年《网中人》达到三百万人收看。当年我二十四岁”。后来转入电影业做导演，说起为什么做导演，王晶开了个玩笑：</p>
<blockquote>
<p>有人为了艺术理想做电影导演。<br>有人为了虚荣心做电影导演。<br>有人为了娱乐圈的五光十色做电影导演。<br>我是为了老婆大肚，愁分娩的费用而做导演的。。。并事先声明并非奉子成婚，这不是道德问题，是不想被人认为我性知识贫乏。。。</p>
</blockquote>
<p>在书中王晶多次提起自己经济出现问题。在九七年香港电影最不景气的时候，他为了保持制作，“把多年来在电影上赚的钱一点一滴的补贴了出去“，虽然同业并不领情。到最后他手头可以调用的资金不多，打算结束电影公司的时候，遇到了一位贵人出手相助，他在叙写之前大发了一番感慨：</p>
<blockquote>
<p>我一生当中有好多次的奇遇，都是因为去了一些没兴趣、不重视、甚至不想去的场合发生的。我们常会把一些场合视为鸡肋，浮起一个去唔去都罷的想法。<br>但这是错的。你永远不知道命运把金币埋在什么地方。上天会眷顾一些尊重朋友、尊重生命、不吝啬去释放善意、释放正能量的人。</p>
</blockquote>
<p>然后他去了一个鸡肋同学会，和之前并不熟络的一位同学聊的很好，后来得到他支持十多年。</p>
<p><br><br>什么是导演的原罪？楚原先生给他讲了一句金句，一下子就给商业片正了名：</p>
<blockquote>
<p>阿晶，电影圈泡女演员不是罪，迟到早退不是罪，扮嘢擺款也不是罪；而只有一条死罪，就是 唔收得！</p>
</blockquote>
<p>港片为什么家道中落，我也觉得是太商业，烂片太多，但是王晶义正严辞的给出了他的答案：</p>
<blockquote>
<p>好多人说港片式微是因为滥拍及急功近利。这根本是阿妈系女人式的理由，讲滥拍，美国几十年来都是最滥拍的电影王国，最 top收过几亿美金的只有三十部左右大片，其他就是近千部几百万到一千万成本的渣片，直接印 DVD、或上电影频道。那些片有的真是任何一部C级港片都好过佢，但美国电影到今天仍影响整个世界。为什么呢？<br><br>因为真正的市场理论指出，好片有观众，渣片也有观众，好多片你不会买飞入场睇，但半夜无聊打开收费电视机，你就会睇。观众形式的不同，会令你有不同选择。老实说，市场好，什麼电影也能生存，市场差，好片烂片一样死，我三代电影人（叔公王鹏翼是五十年代的制片人），数据比任何电影人都多，我知这才是市场定律。</p>
</blockquote>
<p>最近在香港港人和大陆人起了不少冲突， “在内地闯天下的学问”这一章里写了不少他作为一个电影人在大陆的电影江湖里打拼的所见所感，很有意思：</p>
<blockquote>
<p>国内人的价值观跟香港人本质上有太多的不同之处。<br><br>老实讲，港人几十年来的自我优越感，视国内人为素质较低、老土、娘等观念（娘？！），大陆人何尝不知，而且相当反感。被香港人打压了几十年的国内人才，今日遇上了出头天，自我膨胀的比以前的想感人更甚，而且普遍有「你地都有今日咯」的想法，如果香港人与国内人有争拗，很大机会偏向于国内人帮国内人！香港人被围攻，被群插（群插？）的机会极大。</p>
</blockquote>
<p>台湾人我见过，看到这里我愈发觉得，无论是香港人还是台湾人还是大陆人，还真的都是中国人。</p>
<p><br><br>提到《让子弹飞》，王导演更是满肚子委屈：</p>
<blockquote>
<p>取出这几年报批片子及剧本意见一比较。老实说，我也觉得这是两套标准。如果《让子弹飞》的编剧是我，深信是会被剪的体无完肤。当然我没异议，照旧拍我的片好了。猛虎是必然不敌地头蟲的，就付出双倍的努力去追上吧！</p>
</blockquote>
<p><br><br>打官司：</p>
<blockquote>
<p>香港人打的是钱，大陆人打的是人面。<br><br>当然公说公有理，婆说婆有理，谁对谁不对，外人不易了解。但作为在国内工作的香港人，我劝大家万事以和为贵，非到万不得已，不要公堂相见，同时要收敛自己的优越感，因为国内人才辈出，在哪一方面已不输香港人。反而拼搏精神远胜过我们。我们要在国内创出一片新天地，除了努力之外，广结人缘更为重要，多一个朋友点都好过一个敌人。中港一家亲，才是揾食态度。</p>
</blockquote>
<p>这已经是书的最后部分了，和前半生的锋芒毕露相比，实在是圆滑了不少，多了不少佛心，但是难能可贵的是对于他认为改坚持的东西，还是能够义无反顾的坚持。</p>
<p>王晶的父亲王天林先生也是著名导演，回忆起父亲，王晶心酸满满，因为父亲一辈子吃了太多苦，最后一章”给敬爱的父亲“情真意切。王晶小时候家境也并不好，并且——</p>
<blockquote>
<p>这也直接令我的人生态度成形。我决定走不空谈只务实的路，我不能再让家人受我跟父亲一样的苦。所以三十年来我只拍商业片，但我敢说，我给了我家人我能提供的最好的东西。”</p>
</blockquote>
<p><br><br>这本书写的很真诚，以讲故事，和人生感悟为主，对于一些敏感的人事冲突火力并不强（只提到了李翰祥导演打压他以及跟周星驰之间的一段不愉快）：</p>
<blockquote>
<p>因为很多人仍在江湖，许多事我都采用了十分保守的笔法，尽量不要引起不必要的争议或误解。所以又好多很想直写的人与事，我都保留了。到正式退休的那一天，希望我有机会再在这里为大家写一百期的《王晶回首红尘》。相信会更赤裸”</p>
</blockquote>
<p><br><br>这本书没有在大陆出版，否则肯定会被咔嚓掉不少，港币八十八，<a href="http://s.taobao.com/search?q=%E5%B0%91%E5%B9%B4%E7%8E%8B%E6%99%B6%E9%97%AF%E6%B1%9F%E6%B9%96" target="_blank" rel="external">淘宝</a>可以买到。繁体竖排，并且夹杂大量粤语，粤语的部分比较费劲，但是值得一看！</p>
<p><br><br><img src="https://img1.doubanio.com/lpic/s6873849.jpg" alt="少年王晶闯江湖"></p>
<p><br><br>（图片来自豆瓣）</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://post.lxd.me/2014-12-19-interstellar-review/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lxd">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/alex-alice.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Thoughts, notes and collections">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Thoughts, notes and collections" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014-12-19-interstellar-review/" itemprop="url">
                  星际穿越 Interstellar 影评
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-12-19T00:00:00+08:00">
              2014-12-19
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-11-09T18:25:05+08:00">
              2016-11-09
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/film-review/" itemprop="url" rel="index">
                    <span itemprop="name">film review</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014-12-19-interstellar-review/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014-12-19-interstellar-review/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>昨天终于抽出空来赶在星际穿越下线前又去看了一遍，因为电影里永恒号飞过土星，飞过卡冈图雅的画面非大银幕看不过瘾，要是电影下线之后再在大银幕上看这部电影的机会就小很多。为了不亏待自己，再落下一篇影评。</p>
<p>对太空、星际穿越、时间旅行的光影呈现是这部电影最大的看点，就像对梦境的刻画之于Inception。对同类型的的神片2001太空漫游，Interstellar的致敬之处确实不少，让我很意外，因为印象中诺兰可是很骄傲的。<br>另外虽然都是商业片，相比于诺兰导演之前的TDK和Inception，这部Interstellar的堆砌感更重，剥去星际穿越华丽的外衣，再抽掉Family元素，留下的东西并不多。</p>
<p>在演员方面，安妮海瑟薇在出场的时候整个电影院观众一阵骚动——女神出场了！但整部电影下来，导演并没有给她多大的发挥空间，因为串起整部电影的是父女情，风头全被马修麦康纳抢去了。而马修麦康纳也没有辜负导演的期望，将父女之情表演的淋漓尽致，坐在电视机前一把鼻涕一把泪，赚观众的感情分效果好极了。另外马修在这部电影里为了表现柔情的一面，有些场景口齿含混的很夸张，感觉有些做作。 而马特达蒙则是一个惊喜，因为预告片里没有看到他。他虽然在中间才出场，并且很快就挂掉了，但是很出彩，达蒙演反派的代入感就是强！ :)</p>
<p>诺兰是一个技术流导演，重技术轻艺术，拍的电影大气而不细腻，感情戏一直是他电影里若有若无的弱项，而这部电影里却对父女情下了重笔墨来刻画。前面花了大力气来做情感铺垫，中间马修坐在电视机前面眼泪鼻涕横流，到最后和病床上已将要作古的女儿团聚，作为电影的主线效果非常赞！</p>
<p>诺兰的技术风格重不只是电影技术优秀，他拍的电影是情节的技术感也很重，比如Inception和Interstellar都有递归的元素：Inception里从两层梦境到三层梦境到最后跌入limbo；Interstellar里Cooper时空穿越回去给自己的女儿传送信息的同时他自己也明白了更高维空间里的人类在做着同样的事情。更早期的作品记忆碎片，正反双线叙事手法，烧脑都快烧成浆糊了，那部电影应该是他玩的最happy的电影。在致命魔术里还把特斯拉请出来造了一个克隆机器，应该是向这位伟大的科学家致敬，但是让这部复古的电影却很有硬科幻的调调。</p>
<p>和前几部电影一样，这部电影的戏很足，即使是将近3个小时的长度依然塞不下来的感觉，有些部分节奏很快。</p>
<p>后来朋友圈里刷满了这部电影怎么怎么翻拍了三体的段子，但是我是直到影片最后，Cooper从离心机空间站里苏醒过来之后，才联想起三体里修在太阳系修在行型背面的太空城的。其实首先联想到的应该是马特达蒙的Elysium，但是那部电影故事太烂就没太多想。让我吃惊的是离心机的半径好小，怎么住得下那么多人，电影也一直没有给离心机空间站的全景镜头，直到后来Cooper坐在长椅上咂啤酒的时候，导演给了一个纵向的镜头，才发现离心机的轴很长。</p>
<p>说到三体那就在说说三体，三体现在在国内科幻界乃至华人世界里都威望极高，大家提起三体就直呼神作，中国科幻的扛鼎之作云云，我抵抗不住盛威，就看了一遍，但是我没觉得盛传的那么好，作者的天马行空的想象力确实厉害，也将这些想法串联成了一个完整的故事，但是文笔太差了，作为三部小说里一条很重要的爱情线，居然也是班里的内向男生恋上女神的老土套路。看完之后在回味之余总是觉得很可惜。</p>
<p><br><br>这次电影的配乐依旧是由寂寞汉子的作品，诺兰最近几部电影的配乐都是和他合作的，不同于在Inception里用重金属轰鸣：<br><br></p>
<embed src="http://music.163.com/style/swf/widget.swf?sid=1426503&type=2&auto=0&width=320&height=66" width="340" height="86" allownetworking="all">

<p>这次改用管风琴轰鸣了：<br><br></p>
<embed src="http://music.163.com/style/swf/widget.swf?sid=29734868&type=2&auto=0&width=320&height=66" width="340" height="86" allownetworking="all">

<p>另外Interstellar里还时不时的放这一段跟宇宙、时空很应景的很有空灵感的配乐：<br><br></p>
<embed src="http://music.163.com/style/swf/widget.swf?sid=29734857&type=2&auto=0&width=320&height=66" width="340" height="86" allownetworking="all">


<p>盗梦空间里我最喜欢的一段配乐是从Cobb一行人从头等舱醒来，到Cobb惴惴不安的进关，到最后以陀螺悬念结束的配乐：<br><br></p>
<embed src="http://music.163.com/style/swf/widget.swf?sid=1426503&type=2&auto=0&width=320&height=66" width="340" height="86" allownetworking="all">


<p>说到盗梦空间就再说说盗梦空间，盗梦空间从构思上绝妙，但是Ariadne的选角是一个大遗憾，Elen Page在Juno里的表演非常精彩，很有本色出演的感觉（当然我不知道Elen Page在生活中是不是真的这么大大咧咧），但是在Inception里和一帮老爷们在一起，显得太单薄了。在Inception整部电影里除去Mal这个Cobb脑中的角色，就她一个女角色，所以非常重要，但是再看看她在第二层梦境酒店里OL的装束：瘦小、平胸，衣服都撑不起来，实在太单薄了。</p>
<p>没想到在拍完盗梦空间之后又拍出这样一部优秀的原创剧本电影，仅凭借这两部电影就够无数后人仰视这位牛逼的导演了，当然希望诺兰会带来更多优秀的作品。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://post.lxd.me/2014-09-04-using-osx-say-command-to-make-nagios-alert-speak/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lxd">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/alex-alice.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Thoughts, notes and collections">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Thoughts, notes and collections" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014-09-04-using-osx-say-command-to-make-nagios-alert-speak/" itemprop="url">
                  用OSX的say命令让Nagios报警叫出来
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-09-04T00:00:00+08:00">
              2014-09-04
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2017-01-25T14:52:27+08:00">
              2017-01-25
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">tech</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014-09-04-using-osx-say-command-to-make-nagios-alert-speak/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014-09-04-using-osx-say-command-to-make-nagios-alert-speak/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Mac OSX系统有个有趣的命令<code>say</code>，传入一段文本就可以让系统读出来。比如你可以打开OSX的Terminal.app，然后输入<code>say hello OSX</code>，听听会不会响。</p>
<p>因为机缘巧合，我们项目的CI服务器装在一台Mac Pro上了，在写脚本监控CI Server进程或者做CI monitor的报警的时候，就可以用这个<code>say</code>命令把一些信息读出来，再在Mac上插个大喇叭，这样整个项目组都能听得见了。</p>
<p>比如：<code>say Go server went down, no dzuo no die, ha ha ha ha ha</code></p>
<p>当然这样还不够完美，<code>say</code>命令只能在Mac上写脚本的时候可以用，于是我们可以写一个HTTP Server，把<code>say</code>命令包装一下，放在Mac Pro上跑起来，代码可以是这个样子的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</div><div class="line"><span class="keyword">var</span> exec = <span class="built_in">require</span>(<span class="string">'child_process'</span>).exec; </div><div class="line"></div><div class="line">http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> body = <span class="string">""</span>;</div><div class="line">	req.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</div><div class="line">		body += chunk;</div><div class="line">	&#125;);</div><div class="line">	req.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">		res.end();</div><div class="line">		exec(<span class="string">'say '</span> + body);</div><div class="line">	&#125;);</div><div class="line">&#125;).listen(<span class="number">7788</span>);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(<span class="string">'http say now listen on 7788'</span>);</div></pre></td></tr></table></figure>
<p>然后我们在别的机器上，POST数据到这台Mac，这台Mac就可以念出来了，比如这样：<code>curl -X POST -d &quot;No dzuo no die&quot; &lt;MAC_IP_addr&gt;:7788</code></p>
<p>Nagios的报警缺省是发邮件的，很不方便，那么就可以tweak一下Nagios发邮件的配置，让它把消息文本POST到Mac上去念出来，config的配置修改是这样的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># From</span></div><div class="line">define command&#123;</div><div class="line">        command_name    notify-service-by-email</div><div class="line">        command_line    /usr/bin/printf <span class="string">"%b"</span> <span class="string">"***** Icinga *****\n\nNotification Type: $NOTIFICATIONTYPE$\n\nService: $SERVICEDESC$\nHost: $HOSTALIAS$\nAddress: $HOSTADDRESS$\nState: $SERVICESTATE$\n\nDate/Time: $LONGDATETIME$\n\nAdditional Info:\n\n$SERVICEOUTPUT$\n"</span> | /usr/bin/mail -s <span class="string">"** $NOTIFICATIONTYPE$ Service Alert: $HOSTALIAS$/$SERVICEDESC$ is $SERVICESTATE$ **"</span> $CONTACTEMAIL$</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># To</span></div><div class="line">define command&#123;</div><div class="line">        command_name    notify-service-by-http-say</div><div class="line">        command_line    /usr/bin/printf <span class="string">"%b"</span> <span class="string">"$NOTIFICATIONTYPE$, $SERVICEDESC$ on Host $HOSTALIAS$. $SERVICEOUTPUT$"</span> | /usr/bin/curl -X POST -d @- <span class="number">10.18</span><span class="number">.7</span><span class="number">.153</span>:<span class="number">7788</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>curl的<code>-d</code>开关的值<code>@-</code>是让curl从标准输入读数据。</p>
<p>一点奇技淫巧，自娱自乐一下 :)</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://post.lxd.me/2014-07-25-bounce/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lxd">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/alex-alice.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Thoughts, notes and collections">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Thoughts, notes and collections" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014-07-25-bounce/" itemprop="url">
                  向多台机器分发文件 - bounce
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-07-25T11:55:00+08:00">
              2014-07-25
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2017-01-25T14:52:24+08:00">
              2017-01-25
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">tech</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014-07-25-bounce/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014-07-25-bounce/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近在公司遇到了把一个几十G的虚拟机镜像文件分发到10来台机器上的问题，前期基础设施没有搭建好到后来就是会比较痛，如果这些机器用puppet或者chef管理起来了的话这事儿或许会好办一些。</p>
<p>首先当然不能手动一台一台拷贝。</p>
<p>其次也不能同时向这十几台机器，因为：</p>
<ul>
<li>假定文件size是S，出口带宽是B，机器数目是C，</li>
<li>那么分发时间是S/(B/C)，等于(S/B)*C，还是相当于一台一台拷贝的速度</li>
</ul>
<p>有没有更快的方案？<br><br><br>很自然的我们想到了非常高大上P2P方案，这个业界传说facebook和Twitter都在用，用一个定制版的BitTorrent向他们的上千台线上服务器做部署。其实最早听说facebook在用了，但是没有开源出来，Twitter虽然听说的晚，但是却开源了他们的项目，叫<a href="https://github.com/lg/murder" target="_blank" rel="external">Murder</a>，赞Twitter。</p>
<p>因为BT协议的基本原理是把文件打散成块，多台peer机器之间频繁交换文件块。一个文件块从拥有文件的母体机器传输到另外几台机器之后，没有这个文件块的机器就可以从这几台机器去取文件而不仅仅只是从母体去取，复用程度大大提高，粗粗感觉一下似乎确实会快很多。</p>
<p>Murder是用Python写的，因为用到了Python的BitTorrent库BitTornado。然后在外面用Capistrano做了包装，可以敲cap做部署，也可以直接调用作者写的python脚本（<a href="https://github.com/lg/murder/tree/master/dist），参见[这篇博客]。" target="_blank" rel="external">https://github.com/lg/murder/tree/master/dist），参见[这篇博客]。</a></p>
<p>这种方案我试了一下，还是慢，无论是用Murder还是用MlDonkey做种用原生的BitTorrent，原因是用BT在我的环境下传输速率本身就慢，占不满带宽，我也懒得深究为什么了，决定采用B计划。</p>
<p><br><br>B计划跟BT协议类似，但是不再把文件打散成块了：先把文件从最开始的机器A拷贝给机器B，然后机器A和机器B同时向机器C和机器D拷贝，如此下去。。。因为同时拷贝的机器是呈指数级别上升的，所以越到后来分发速度还是挺客观的呵呵，但是起步时分发速度还是太慢。</p>
<p>怎么证明这种方式最起码会比从一台机器同时向十几台机器拷贝快呢？如下图所示</p>
<p><img src="/images/bounce-is-faster-figure.png" alt="bounce is faster"></p>
<p>横轴是机器数量C，纵轴是size为S的文件从一台机器占满带宽B传输到另一台机器所需的时间T（T=S/B）。</p>
<ul>
<li>用一台机器同时向其他机器分发的方法，花费时间和机器数量成正比，很好理解。</li>
<li>用B计划的话当只有有一台机器接收文件的时候需要一次对拷，花费时间T；当有两台机器的时候需要两次对拷，花费时间2T；当有三台机器的时候还是两次对拷，2T，如此这般，把线连接起来就是对数曲线，只要机器数大于两台就能保证这种方法更快。</li>
</ul>
<p><br><br>用B计划的话就终于免不了IPC了，因为文件从母体A传输到机器B之后机器B得想办法告知机器A我收到文件了，可以作为新的母体向别的机器传播文件了，并且在原始母体机器上得有一个主控程序来控制整个分发流程的完成。</p>
<p>我设计的分发算法简单来说是这样的：</p>
<ul>
<li>首先有三个集合set0，set1和set2，set0里包含已经持有完整文件可以向别的host分发的的host，set1包含没有文件待分发的host，set2包含正在发送或接收的host，初始状态是这样的：<ul>
<li>set0 = {A}</li>
<li>set1 = {B, C, D, E, F, G}</li>
<li>set2 = {}</li>
</ul>
</li>
<li>从set0中pick出一个host作为发送方，从set1中pick出一个host作为接收方，讲这两个host放入set2，然后执行拷贝<ul>
<li>set0 = {}</li>
<li>set1 = {C, D, E, F, G}</li>
<li>set2 = {A, B}</li>
</ul>
</li>
<li>重复上面这个过程直到：<ul>
<li>当set1为空并且set2为空时分发结束</li>
<li>当set1为空但是set2不为空时说明正在执行最后一轮对拷，等待</li>
<li>当set0为空时说明没有足够的母体，等待</li>
</ul>
</li>
<li>当某次传输完成后将发送方host和接收方host都从set2中取出来放进set0，然后重新触发上面的过程</li>
</ul>
<p><br><br><br>代码我用node实现，在github上，叫<a href="https://github.com/lxdcn/bounce" target="_blank" rel="external">bounce</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://post.lxd.me/2014-07-24-running-powershell-in-parallel/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lxd">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/alex-alice.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Thoughts, notes and collections">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Thoughts, notes and collections" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014-07-24-running-powershell-in-parallel/" itemprop="url">
                  在PowerShell里并行执行脚本
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-07-24T16:18:29+08:00">
              2014-07-24
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2017-01-25T14:52:17+08:00">
              2017-01-25
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">tech</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014-07-24-running-powershell-in-parallel/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014-07-24-running-powershell-in-parallel/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在Bash里并行执行脚本有几种方法，可以在Bash里可以用把一个任务后面加<code>&amp;</code>开一个subshell直接甩倒后台去执行，也可以用<a href="http://www.gnu.org/software/parallel/" title="GNU Parallel" target="_blank" rel="external">GNU Parallel</a>对并行执行的任务做更精细的控制。</p>
<p>而在PowerShell脚本里并行执行脚本，也有多种方法，一是用<code>Start-Job</code>命令启动一个background job，二是用并行的Workflow。</p>
<p>并行的Workflow PowerShell 2不支持，并且PowerShell的Workflow有一个很明确的限制是不能包含交互的命令。比如你需要把一段PowerShell脚本从串行改成并行，但是这段脚本又里使用了<code>Write-Host</code>命令直接打印到host的话，PowerShell就会无情的报错<code>Cannot call the &#39;Write-Host&#39; command. Other commands from this module have been packaged as workflow activities, but this command was specifically excluded.</code>，你就得自己看着办了，比如用<code>Write-Output</code>。<br><br><br>我用了background job的方案，相对于Bash的subshell后台执行命令，PowerShell提供了更为丰富的命令来控制background job，我用到了这么几个：</p>
<ul>
<li><code>Start-Job</code>，启动一个background job，这个命令定义一个background job的同时直接启动这个background job，我用到了几个参数：<ul>
<li><code>-ScriptBlock</code> 需要执行的代码块</li>
<li><code>-InitializationScript</code> 初始化代码块</li>
<li><code>-Name</code> Job命名</li>
<li><code>-InputObject</code> 传给background job的参数，如果需要传多个参数的话需要封装成一个Object，然后在ScriptBlock里再解析出来</li>
</ul>
</li>
<li><code>Wait-Job</code>，阻塞等待background job结束，等待的background job可以有多个，作为参数传进去</li>
<li><code>Receive-Job</code>，获取background job的结果，我用这个命令来获取background job的终端输出，需要被获取的background job也可以有多个，作为参数传进去</li>
<li><code>Remove-Job</code>，当一个background job结束之后就可以用这个命令删除这个job</li>
</ul>
<p><br><br>一个简单的例子：<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># background job需要执行的代码</span></div><div class="line"><span class="comment"># $Input是传进来的参数，是个Enumerator，需要遍历取出来</span></div><div class="line"><span class="variable">$execWrapper</span> = &#123;</div><div class="line">    <span class="keyword">function</span> Exec &#123;</div><div class="line">        <span class="variable">$Input</span> | %&#123;</div><div class="line">            <span class="variable">$Param</span> = <span class="variable">$_</span></div><div class="line">        &#125;</div><div class="line">        <span class="built_in">Start-Sleep</span> <span class="number">1</span></div><div class="line">        <span class="built_in">Write-Output</span> <span class="string">"This is job <span class="variable">$Param</span>"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># 一般来讲业务上会有一个数组传进来，然后针对每个数组元素创建job并行执行</span></div><div class="line"><span class="variable">$data</span> = @(<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>)</div><div class="line"></div><div class="line"><span class="comment"># 遍历数组，创建job，Start-Job的同时Job就会执行，创建后将这些job存入$jobs数组</span></div><div class="line"><span class="comment"># Start-Job的参数分别是</span></div><div class="line"><span class="comment">#   -ScriptBlock 需要执行的代码块</span></div><div class="line"><span class="comment">#   -InitializationScript 初始化代码块</span></div><div class="line"><span class="comment">#   -Name Job命名</span></div><div class="line"><span class="comment">#   -InputObject 传给background job的参数</span></div><div class="line"><span class="variable">$jobs</span> = @()</div><div class="line"><span class="variable">$data</span> | %&#123;</div><div class="line">    <span class="variable">$job</span> = <span class="built_in">Start-Job</span> -ScriptBlock &#123;Exec&#125; -InitializationScript <span class="variable">$execWrapper</span> -Name <span class="variable">$_</span> -InputObject <span class="variable">$_</span></div><div class="line">    <span class="variable">$jobs</span> += <span class="variable">$job</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># 等待所有后台job结束</span></div><div class="line"><span class="literal">$null</span> = <span class="built_in">Wait-Job</span> -Job <span class="variable">$jobs</span></div><div class="line"></div><div class="line"><span class="comment"># 从Job接收终端输出，打印到当前终端</span></div><div class="line"><span class="variable">$jobs</span> | %&#123;</div><div class="line">    <span class="built_in">Write-Output</span> $(<span class="built_in">Receive-Job</span> -Job <span class="variable">$_</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># 清理掉job</span></div><div class="line"><span class="built_in">Remove-Job</span> -Job <span class="variable">$jobs</span></div><div class="line"><span class="built_in">Get-Job</span></div></pre></td></tr></table></figure></p>
<p><br><br>但是<a href="http://isaachan.github.io/" target="_blank" rel="external">韩老师</a>指出，这种方法有很大缺陷。当background job执行时间很长的时候，如果我们先Wait它们执行完毕，再获取background job的输出，那么造成的效果就是当前的PowerShell session会hang住很长时间，造成很糟糕的运维体验。</p>
<p>那么就不能用<code>Wait-Job</code>命令了，要在background job还在running的时候，用<code>Receive-Job</code>“实时的”获取到它的终端输出，打印到当前的PowerShell上。</p>
<p>具体的做法是用一个循环来轮询，检查各个background job是否还有数据可读，如果可读，就用<code>Receive-Job</code>命令取出这个background job的result，再<code>Write-Host</code>到当前的PowerShell里。如果没有可读的的background job，则认为所有job都跑完了，此时就相当于<code>Wait-Job</code>释放的那一刻，从循环中跳出，再执行后续操作。</p>
<p>改进后的代码是这样的：<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 扩充一下background job需要执行的代码</span></div><div class="line"><span class="variable">$execWrapper</span> = &#123;</div><div class="line">    <span class="keyword">function</span> Exec &#123;</div><div class="line">        <span class="variable">$Input</span> | %&#123;</div><div class="line">            <span class="variable">$Param</span> = <span class="variable">$_</span></div><div class="line">        &#125;</div><div class="line">        <span class="built_in">Start-Sleep</span> <span class="number">1</span></div><div class="line">        <span class="built_in">Write-Output</span> <span class="string">"This is job <span class="variable">$Param</span>"</span></div><div class="line">        <span class="built_in">Start-Sleep</span> <span class="number">1</span></div><div class="line">        <span class="built_in">Write-Output</span> <span class="string">"This is job <span class="variable">$Param</span> again"</span></div><div class="line">        <span class="built_in">Start-Sleep</span> <span class="number">1</span></div><div class="line">        <span class="built_in">Write-Output</span> <span class="string">"This is job <span class="variable">$Param</span> again, again"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="variable">$data</span> = @(<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>)</div><div class="line"></div><div class="line"><span class="variable">$jobs</span> = @()</div><div class="line"><span class="variable">$data</span> | %&#123;</div><div class="line">    <span class="variable">$job</span> = <span class="built_in">Start-Job</span> -ScriptBlock &#123;Exec&#125; -InitializationScript <span class="variable">$execWrapper</span> -Name <span class="variable">$_</span> -InputObject <span class="variable">$_</span></div><div class="line">    <span class="variable">$jobs</span> += <span class="variable">$job</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># 因为要实时打印出background job的输出，那么就不能调用这个函数被动等待所有background job结束</span></div><div class="line"><span class="comment"># $null = Wait-Job -Job $jobs</span></div><div class="line"></div><div class="line"><span class="comment"># 改用手动循环检查job的状态，同时将background job的输出打印到当前终端</span></div><div class="line"><span class="keyword">While</span> (<span class="number">1</span>) &#123;</div><div class="line">    <span class="variable">$JobsRunning</span> = <span class="number">0</span></div><div class="line">    <span class="variable">$jobs</span> | %&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="variable">$_</span>.HasMoreData) &#123;</div><div class="line">            <span class="variable">$JobsRunning</span> += <span class="number">1</span></div><div class="line">            <span class="comment">#在这里将background job的输出打印到当前终端</span></div><div class="line">            <span class="built_in">Write-Output</span> <span class="string">"This is result of Job $(<span class="variable">$_</span>.Name) :"</span></div><div class="line">            <span class="built_in">Write-Output</span> $(<span class="built_in">Receive-Job</span> -Job <span class="variable">$_</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">   <span class="keyword">if</span> (<span class="variable">$JobsRunning</span> <span class="nomarkup">-eq</span> <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">Break</span></div><div class="line">   &#125;</div><div class="line">   <span class="built_in">Start-Sleep</span> <span class="number">1</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">Remove-Job</span> -Job <span class="variable">$jobs</span></div><div class="line"><span class="built_in">Get-Job</span></div></pre></td></tr></table></figure></p>
<p><br><br><br>当然在具体场景下面还有更多的坑要去趟，比如要改写在background job里执行的PowerShell代码用的是<code>Write-Host</code>，因为<code>Write-Host</code>是数据直接写向host，而不是pipeline，那么<code>Receive-Job</code>的用法就不一样了，它也会直接写向host。再比如你需要串行改并行的PowerShell脚本本身是在一个PowerShell Module里面，并且background job需要调用当前这个Module里的另外一个函数。</p>
<p>因为Start一个background job是开一个全新的PowerShell session，在这个全新的PowerShell session里没有Import这个Module，所以会提示这个函数找不到。</p>
<p>这时候我采用的方法是在<code>Start-Job</code>的<code>-InputObject</code>参数里把当前脚本所在的Module的psm1文件路径封装进去传进去，background job启动之后再解析出这个psm1文件路径重新<code>Import-Module</code>。</p>
<p>因为PowerShell 2和PowerShell 4的<code>$PSScriptRoot</code>含义不同，为了避免兼容性问题，我用了<code>$MyInvocation</code>。大概是这样的：<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$currentModulePath</span> = <span class="string">"$(split-path -parent <span class="variable">$MyInvocation</span>.MyCommand.Definition)\psmodule.psm1"</span></div><div class="line"><span class="variable">$execWrapper</span> = &#123;</div><div class="line">    <span class="keyword">function</span> Exec &#123;</div><div class="line">        <span class="variable">$Input</span> | %&#123;</div><div class="line">            <span class="built_in">Import-Module</span> <span class="variable">$_</span>[<span class="string">'currentModulePath'</span>] -Force | <span class="built_in">Out-Default</span></div><div class="line">            <span class="variable">$Param</span> = <span class="variable">$_</span>[<span class="string">'data'</span>]</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">Start-Sleep</span> <span class="number">1</span></div><div class="line">        <span class="built_in">Write-Output</span> <span class="string">"This is job <span class="variable">$Param</span>"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">...</div><div class="line"><span class="variable">$job</span> = <span class="built_in">Start-Job</span> -ScriptBlock &#123;Exec&#125; -InitializationScript <span class="variable">$execWrapper</span> -Name <span class="variable">$_</span> -InputObject @&#123;<span class="keyword">data</span>=<span class="variable">$_</span>; currentModulePath=<span class="variable">$currentModulePath</span>&#125;</div><div class="line">...</div><div class="line"></div></pre></td></tr></table></figure></p>
<p><br><br>完了，有机会再整理一下<a href="http://www.gnu.org/software/parallel/" title="GNU Parallel" target="_blank" rel="external">GNU Parallel</a>。<br><br><br><br>参考：</p>
<ul>
<li><a href="http://technet.microsoft.com/en-us/library/hh849698.aspx" target="_blank" rel="external">Start-Job</a></li>
<li><a href="http://technet.microsoft.com/en-us/library/hh849735.aspx" target="_blank" rel="external">Wait-Job</a></li>
<li><a href="http://technet.microsoft.com/en-us/library/hh849718.aspx" target="_blank" rel="external">Receive-Job</a></li>
<li><a href="http://vwiki.co.uk/Background_Jobs_%28PowerShell%29" target="_blank" rel="external">Background Jobs (PowerShell)</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://post.lxd.me/2014-07-22-hello-world/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lxd">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/alex-alice.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Thoughts, notes and collections">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Thoughts, notes and collections" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014-07-22-hello-world/" itemprop="url">
                  Hello World
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-07-22T00:00:00+08:00">
              2014-07-22
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-11-09T18:22:19+08:00">
              2016-11-09
            </time>
            
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014-07-22-hello-world/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014-07-22-hello-world/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is <code>your</code> very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/alex-alice.png"
               alt="lxd" />
          <p class="site-author-name" itemprop="name">lxd</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">18</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lxd</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'post-lxd-me';
      var disqus_identifier = 'page/2/index.html';

      var disqus_title = "";


      function run_disqus_script(disqus_script) {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');

      

    </script>
  





  
  

  

  

  

  


</body>
</html>
